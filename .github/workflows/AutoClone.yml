name: AutoClone

on: 
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  AutoClone:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          persist-credentials: false

      - name: Extract and Update IDA Plugins
        run: |
          #!/bin/bash
          set -e
          
          # é…ç½®Git
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://${{ github.actor }}:${{ secrets.ACCESS_TOKEN }}@github.com/${{ github.repository }}
          
          # ä»READMEä¸­æå–æ‰€æœ‰GitHubé“¾æ¥
          echo "ğŸ“– Extracting GitHub repositories from README.md..."
          repos=$(grep -oP 'https://github\.com/[^)]+' README.md | sort -u)
          
          updated_count=0
          cloned_count=0
          failed_count=0
          failed_repos=""
          
          # å¤„ç†æ¯ä¸ªä»“åº“
          for repo_url in $repos; do
            # æå–ä»“åº“åï¼ˆæœ€åä¸€éƒ¨åˆ†ï¼‰
            repo_name=$(basename "$repo_url")
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ -d "$repo_name" ]; then
              # å·²å­˜åœ¨çš„ä»“åº“ï¼Œæ‰§è¡Œå¢é‡æ›´æ–°
              echo "ğŸ”„ Updating: $repo_name"
              cd "$repo_name"
              
              if git pull origin HEAD 2>/dev/null; then
                echo "âœ… Updated successfully: $repo_name"
                ((updated_count++))
              else
                echo "âš ï¸  Update failed, trying fresh clone: $repo_name"
                cd ..
                rm -rf "$repo_name"
                if git clone "$repo_url" 2>/dev/null; then
                  rm -rf "$repo_name/.git"
                  echo "âœ… Fresh clone successful: $repo_name"
                  ((cloned_count++))
                else
                  echo "âŒ Failed: $repo_name"
                  ((failed_count++))
                  failed_repos="$failed_repos\n  - $repo_name ($repo_url)"
                fi
              fi
              cd ..
            else
              # æ–°ä»“åº“ï¼Œæ‰§è¡Œclone
              echo "ğŸ“¥ Cloning new: $repo_name"
              if git clone "$repo_url" 2>/dev/null; then
                rm -rf "$repo_name/.git"
                echo "âœ… Cloned successfully: $repo_name"
                ((cloned_count++))
              else
                echo "âŒ Clone failed: $repo_name"
                ((failed_count++))
                failed_repos="$failed_repos\n  - $repo_name ($repo_url)"
              fi
            fi
          done
          
          # æ‰“å°ç»Ÿè®¡ä¿¡æ¯
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Summary:"
          echo "  ğŸ”„ Updated: $updated_count"
          echo "  ğŸ“¥ Cloned: $cloned_count"
          echo "  âŒ Failed: $failed_count"
          
          if [ $failed_count -gt 0 ]; then
            echo ""
            echo "Failed repositories:$failed_repos"
          fi
          
          # æäº¤æ›´æ”¹
          git add .
          if git diff --staged --quiet; then
            echo ""
            echo "âœ¨ No changes to commit"
          else
            git commit -m "chore: Auto update IDA plugins (Updated: $updated_count, Cloned: $cloned_count, Failed: $failed_count)"
            git push origin main
            echo ""
            echo "âœ… Changes committed and pushed successfully"
          fi
