name: AutoClone

on: 
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  AutoClone:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          persist-credentials: false

      - name: Extract and Update IDA Plugins
        run: |
          # é…ç½®Git
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://${{ github.actor }}:${{ secrets.ACCESS_TOKEN }}@github.com/${{ github.repository }}
          
          # ä»READMEä¸­æå–æ‰€æœ‰GitHubé“¾æ¥
          echo "ğŸ“– Extracting GitHub repositories from README.md..."
          repos=$(grep -oE 'https://github\.com/[^)]+' README.md | sort -u)
          
          updated=0
          cloned=0
          failed=0
          
          for repo_url in $repos; do
            repo_name=$(basename "$repo_url")
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ -d "$repo_name" ]; then
              echo "ğŸ”„ Updating: $repo_name"
              rm -rf "$repo_name"
              if git clone "$repo_url" 2>&1; then
                rm -rf "$repo_name/.git"
                echo "âœ… Updated: $repo_name"
                updated=$((updated + 1))
              else
                echo "âŒ Failed: $repo_name"
                failed=$((failed + 1))
              fi
            else
              echo "ğŸ“¥ Cloning: $repo_name"
              if git clone "$repo_url" 2>&1; then
                rm -rf "$repo_name/.git"
                echo "âœ… Cloned: $repo_name"
                cloned=$((cloned + 1))
              else
                echo "âŒ Failed: $repo_name"
                failed=$((failed + 1))
              fi
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Summary: Updated=$updated, Cloned=$cloned, Failed=$failed"
          
          # æäº¤æ›´æ”¹
          git add .
          if git diff --staged --quiet; then
            echo "âœ¨ No changes to commit"
          else
            git commit -m "chore: Auto update IDA plugins (Updated: $updated, Cloned: $cloned, Failed: $failed)"
            git push origin main
            echo "âœ… Changes pushed successfully"
          fi
